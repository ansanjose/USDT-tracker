<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USDT Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Binance P2P USDT Tracker</h1>

  <label for="currency">Selecciona moneda:</label>
  <select id="currency">
    <option value="ARS">ARS</option>
    <option value="BRL">BRL</option>
    <option value="EUR">EUR</option>
    <option value="BOB">BOB</option>
  </select>

  <canvas id="priceChart" width="400" height="200"></canvas>

  <div class="ad-banner">
    <!-- Google AdSense (to be added later) -->
    <p>Ad Banner Placeholder</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('priceChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Ahora'],
        datasets: [{
          label: 'Precio promedio (USDT)',
          data: [0],
          borderColor: 'blue',
          borderWidth: 2,
          fill: false,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });

    async function fetchPrice(currency) {
      try {
        const response = await fetch('/api/proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            asset: "USDT",
            fiat: currency,
            tradeType: "SELL",
            page: 1,
            rows: 5,
            merchantCheck: false
          })
        });
        const data = await response.json();

        if (!data.data || data.data.length === 0) {
          alert('No se encontraron datos para ' + currency);
          return;
        }

        const prices = data.data.map(adv => parseFloat(adv.adv.price));
        const average = prices.reduce((a, b) => a + b, 0) / prices.length;

        // Añadir nuevo dato al gráfico
        chart.data.labels.push(new Date().toLocaleTimeString());
        chart.data.datasets[0].data.push(average.toFixed(2));
        chart.update();
      } catch (error) {
        alert('Error al obtener datos: ' + error.message);
      }
    }

    const dropdown = document.getElementById('currency');
    dropdown.addEventListener('change', () => {
      chart.data.labels = ['Ahora'];
      chart.data.datasets[0].data = [0];
      fetchPrice(dropdown.value);
    });

    fetchPrice(dropdown.value); // carga inicial
  </script>
</body>
</html>
